{% extends "base.html" %}

{% block title %}Админ-панель{% endblock %}
{% block page_title %}Админ-панель{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Управление документами
        
        <div style="float: right; display: flex; gap: 1rem;">
            <a href="{{ url_for('admin_reindex_all') }}" class="btn-reindex-all">Переиндексировать все</a>
            <button onclick="deleteAllDocuments()" class="btn-delete-all">Удалить все</button>
            <a href="{{ url_for('admin_clear_cache') }}" class="btn-clear-cache">Очистить кэш</a>
        </div>
    </div>
    
    <div class="card-body" id="admin-table-container">
        <!-- таблица подгружается сюда через JS -->
    </div>
</div>

<script>
    function loadAdminTable() {
        fetch('/api/docs')
            .then(r => r.json())
            .then(data => {
                let html = '<table class="table"><thead><tr><th>Файл</th><th>Дата</th><th>Статус</th><th>Действия</th></tr></thead><tbody>';
                
                if (data.length === 0) {
                    html += '<tr><td colspan="4" class="empty">Нет документов</td></tr>';
                } else {
                    data.forEach(doc => {
                        let badge = '';
                        if (doc.status === 'indexed') badge = 'badge-success';
                        else if (doc.status === 'indexing') badge = 'badge-warning';
                        else badge = 'badge-danger';

                        html += `
                            <tr>
                                <td><strong>${doc.filename}</strong></td>
                                <td>${doc.added_date}</td>
                                <td><span class="badge ${badge}">${doc.status}</span></td>
                                <td>
                                    <a href="/admin/delete/${doc.filename}" class="action-delete">Удалить</a>
                                    <a href="/admin/reindex/${doc.filename}" class="action-reindex">Переиндексировать</a>
                                </td>
                            </tr>`;
                    });
                }
                
                html += '</tbody></table>';
                document.getElementById('admin-table-container').innerHTML = html;
            })
            .catch(err => console.error('Ошибка загрузки таблицы:', err));
    }

    function deleteAllDocuments() {
        if (!confirm("Вы уверены, что хотите удалить ВСЕ документы?\n\nЭто действие нельзя отменить.")) {
            return;
        }
        window.location.href = "/admin/delete_all";
    }

    loadAdminTable();
    setInterval(loadAdminTable, 3000);
</script>

<style>
    .btn-reindex-all { padding:0.5rem 1rem; background:#f59e0b; color:white; border-radius:6px; text-decoration:none; font-size:0.9rem; }
    .btn-reindex-all:hover { background:#d97706; }
    .btn-delete-all { padding:0.5rem 1rem; background:#ef4444; color:white; border:none; border-radius:6px; font-size:0.9rem; cursor:pointer; }
    .btn-delete-all:hover { background:#dc2626; }
    .btn-clear-cache { padding:0.5rem 1rem; background:#6b7280; color:white; border:none; border-radius:6px; font-size:0.9rem; cursor:pointer; text-decoration:none; }
    .btn-clear-cache:hover { background:#4b5563; }
    .action-delete { color:#ef4444; margin-right:1rem; text-decoration:none; }
    .action-reindex { color:#3b82f6; text-decoration:none; }
    .empty { text-align:center; padding:2.5rem; color:#6b7280; font-style:italic; }
</style>
{% endblock %}